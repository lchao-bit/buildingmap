<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">  <!-- zc,声 明 网页语言 --> 
<head>
    <meta charset="utf-8" />  <!-- zc,使用中文 -->
    <title>Leaflet test</title>
	<style>
		#map { height: 800px; }
	</style>
	<link rel="stylesheet" href="leaflet.css" />
	<link rel="stylesheet" href="leaflet.label.css" />
	<script src="leaflet-src.js"></script>
	<script src="TileLayer.GeoJSON.js"></script>	
	<script src="leaflet.label-src.js"></script>
	<script src="leaflet.label.js"></script>
	<script src="OSMBuildings-Leaflet.debug.js"></script>
	
	<!-- 库文件的添加 -->
</head>
<body>
		<!-- zc,添加路况按钮 -->
	
<div>
		<select name="select year" id="select year">
	   <option value="2010">2010</option>
	  </select>
	  
	  <select name="select month" id="select month">
     <option value="03">03</option>
    </select>
    
    <select name="select day" id="select day">
     <option value="12">12</option>
    </select>
    
		<select name="select hour" id="select hour">
	 	 <option value="0">0点</option>
		  <option value="1">1点</option>
		  <option value="2">2点</option>
		  <option value="3">3点</option>
		  <option value="4">4点</option>
		  <option value="5">5点</option>
		  <option value="6">6点</option>
		  <option value="7">7点</option>
		  <option value="8">8点</option>
		  <option value="9">9点</option>
		  <option value="10">10点</option>
		  <option value="11">11点</option>
		  <option value="12">12点</option>
		  <option value="13">13点</option>
		  <option value="14">14点</option>
		  <option value="15">15点</option>
		  <option value="16">16点</option>
		  <option value="17">17点</option>
		  <option value="18">18点</option>
		  <option value="19">19点</option>
		  <option value="20">20点</option>
		  <option value="21">21点</option>
		  <option value="22">22点</option>
		  <option value="23">23点</option>
	  </select>
		<select name="select minute" id="select minute">
		   <option value="1">0-4分</option>
		  <option value="2">5-9分</option>
		  <option value="3">10-14分</option>
		  <option value="4">15-19分</option>
		  <option value="5">20-24分</option>
		  <option value="6">24-29分</option>
		  <option value="7">30-34分</option>
		  <option value="8">35-39分</option>
		  <option value="9">40-44分</option>
		  <option value="10">45-49分</option>
		  <option value="11">50-54分</option>
		  <option value="12">55-59分</option>
		</select>
	<button id="road map">显示路况</button>
	<button id="road map close">取消显示路况</button>
	</div>
	<!-- zc,添加路况结束 -->
	<div id="map">
	</div>	
	<!-- zc,注册事件函数,浏览器点击事件 -->
	<script>
		var roadCondition_flag=0;//路况触发信号
		//var countFlag=0;
		var roadConditionTime = 1; //路况时间参数
		
  	document.getElementById('road map').onclick = function(){
    	//road_flag = 1;
    	roadCondition_flag = 1;
//    	if(countFlag == 0) changeCenter = 1;
//    	countFlag++;
    	var selectHour = document.getElementById("select hour");
    	var hourValue = selectHour.value;
    	var selectMinute = document.getElementById("select minute");
    	var minuteValue = selectMinute.value;
    	var tempCondition = roadConditionTime;
    	roadConditionTime = parseInt(hourValue)*4 + parseInt(minuteValue) + 1;
    	if(roadConditionTime != tempCondition)
    		{
//   			changeCenter = 1;
//    			roadConditionStorageFlag = 0;
					map.removeLayer(GeoJSONRoadConditionLayer);
      	}
    GeoJSONRCURL = url1+'t/{z}/{x}/{y}' + '/2010/03/12/' + roadConditionTime;//'/15/26969/12418'
		GeoJSONRoadConditionLayer = new L.TileLayer.GeoJSON(GeoJSONRCURL,{maxZoom:19,minZoom:13},
  		{
  			style:myroadconditionstyle,
  			onEachFeature:myoneach,
  			filter:myRoadConditionfilter
  		}) 
  		map.addLayer(GeoJSONRoadConditionLayer);
  	}
  	document.getElementById('road map close').onclick = function(){
  		roadCondition_flag = 0;
  		map.removeLayer(GeoJSONRoadConditionLayer);
  	}
	</script>
	<!-- zc,浏览器点击事件结束 -->

	<script>
		//var map = L.map('map',{maxZoom:19,minZoom:13}).setView([39.894, 116.3155], 13);
		var map = L.map('map',{maxZoom:19,minZoom:13}).setView([39.894, 116.3155/*42.800323, -1.636461*/], 13);
		//创建地图容器以及定义初始点
	</script>
	<script>//zc,添加比例尺
		var scaleControl = L.control.scale({  
  
                   position: 'bottomleft'  
  
         });  
  
         map.addControl(scaleControl);  
		</script>

	<script src="water.js"></script>	
	<script src="ways.js"></script>
	<script src="landcover.js"></script>	
	<script src="railway.js"></script>	
	<!-- 样式表的添加 -->
	<script>
		var shopIcon =new L.Icon(
		{
			iconUrl: 'images/shop.png',
			iconSize:     [16, 16], 
			iconAnchor:   [8, 8]
		});
		var waitingIcon =new L.Icon(
		{
			iconUrl: 'images/waiting.png',
			iconSize:     [16, 16], 
			iconAnchor:   [8, 8]
		});
		//添加室内图标类型
		function styleSheet() {
			this.color			=undefined;
			this.fillColor		=undefined;
			this.weight			=undefined;
			this.dashArray		=undefined;
			this.lineCap		='round';
			this.lineJoin		='round';
			this.line_clip		=false;
			this.opacity		=1;
			this.fillOpacity	=0;
		}
		//样式表原型
		function mystyle(feature){
			if(map.getZoom()>18){
				if(feature.properties.room==='building')
				{
					return {color: "#ff0000",weight: 1,fill:true,fillColor:'#cccccc',fillOpacity:1};
				}
				if(feature.properties.room==='waiting')
				{
					return {color: "#ff0000",weight: 1,fill:true,fillColor:'#ff88ff',fillOpacity:1};
				}
				if(feature.properties.room==='shop')
				{
					return {color: "#ff0000",weight: 1,fill:true,fillColor:'#88ffff',fillOpacity:1};
				}
				if(feature.properties.room)
				{
					return {color: "#ff0000",weight: 1,fill:true,fillColor:'#ffff88',fillOpacity:1};
				}
			}
			//室内样式的定义
			else{
				var zoom = map.getZoom();
				var style=new styleSheet();
				var style=waterCss(feature.properties,zoom,style);
				var style=waysCss(feature.properties,zoom,style);
				var style=landcoverCss(feature.properties,zoom,style);
				var style=railwayCss(feature.properties,zoom,style);
				if(style.fillColor!==undefined)
				{
					style.fillOpacity=1;
				}
				return style;
			}
			//将样式表原型与缩放等级传入赋值函数
		};
		
		//zc
			function myroadconditionstyle(feature)
			{
				var zoom = map.getZoom();
			
					//zc,添加路况样式------------
				if(roadCondition_flag == 1 && feature.properties.highway != undefined && feature.properties.highway != null) {
			 		//根据道路渲染规则"stylesheets/ways.js" 初始化道路对象
					
					if(feature.properties.average_speed<10)
					{
						return {color:'#EE0000',weight:6,fill:false,fillOpacity:0.2};//线条颜色 拥堵
					}
					if(feature.properties.average_speed>=10 && feature.properties.average_speed<20)
					{
							//return {color:'#EEAD0E',weight:6,fill:false};//线条颜色 缓行
							return {color:'#FFCC00',weight:6,fill:false,fillOpacity:0.5};
					}
					if(feature.properties.average_speed>=20)
					{
						//return {color:'#7FFF00',weight:6,fill:false};//线条颜色 顺畅
						return {color:'#66FF00',weight:6,fill:false,fillOpacity:0.6};
					}
					if(feature.properties.average_speed==null || feature.properties.average_speed==undefined)
					{
						return {color:'#DCDCDC',weight:6,fill:false,fillOpacity:0.7};//线条颜色 顺畅#DCDCDC
					}
			 		
				};//if type==way end
				//zc-------------------------
				return style;
			};
			
		var iconArray=[];
		var iconcount=0;
		var labelArray=[];
		var labelcount=0;
		//标记图标和文字标签对象以便处理
		function myoneach(feature,layer){
			if(map.getZoom()<feature.properties.minzoom)
			{
				return;
			}
			if(map.getZoom()>18){
				if(feature.properties.room==='waiting'){
					iconArray[iconcount] = L.marker(layer.getBounds().getCenter(),{icon:waitingIcon});
					map.addLayer(iconArray[iconcount]);
					iconcount++;
				}
				if(feature.properties.room==='shop'){
					iconArray[iconcount] = L.marker(layer.getBounds().getCenter(),{icon:shopIcon});
					map.addLayer(iconArray[iconcount]);
					iconcount++;
				}
				var label = new L.Label();
				labelArray[labelcount]=label;
				labelcount++;
				label.setContent(feature.properties.name);
				label.setLatLng(layer.getBounds().getCenter());
				map.showLabel(label);	
			}
			//为室内对象绑定图标
			else if(map.getZoom()>=15){
				if(feature.geometry.type==='LineString'&&!feature.properties.room&&!feature.properties.building&&!feature.properties.level&&feature.properties.name)
				{
					
					var label = new L.Label();
					for(x in labelArray)
					{
						if(feature.properties.name ===labelArray[x]._content)
						{
							return;
						}
					}
					labelArray[labelcount]=label;
					labelcount++;
					label.setContent(feature.properties.name);
					label.setLatLng(layer.getBounds().getCenter());
					map.showLabel(label);			 
				}
			}
			//在缩放15级以上添加文字标签
		};
		function myLowfilter(feature,layer){
			if(map.getZoom()<feature.properties.minzoom)
			{
				return false;
			}
			if(map.getZoom()>18){
				if(feature.properties.room==='building')
				{
					return true;
				}
				else
				{
					return false;
				}
			}
			else{
				if(feature.geometry.type==='Point'||feature.properties.level||feature.properties.building||feature.properties.natural==='water'||feature.properties.railway){
					return false;
				}
				else{
					if(feature.geometry.type==='Polygon'||feature.geometry.type==='MultiPolygon')
					return true;
				}
			}
		};
		function myHighfilter(feature,layer){
			if(map.getZoom()<feature.properties.minzoom)
			{
				return false;
			}
			if(map.getZoom()>18){
				if(feature.properties.level&&feature.properties.room&&feature.properties.room!=='building'&&feature.geometry.type!=='Point'){
					return true;
				}
				else{
					return false;
				}
			}
			else{
				if(feature.geometry.type==='Point'||feature.properties.level||feature.properties.building){
					return false;
				}
				else{
					if(feature.geometry.type!=='Polygon'||feature.properties.natural==='water'||feature.properties.railway)
					return true;
				}
			}
		};
		/*zc,Roadconditionfilter路况过滤器-----------------*/
		function myRoadConditionfilter(feature,layer)
		{
			if(map.getZoom() < feature.properties.minzoom ||roadCondition_flag==0) 
			{
				return false;
			}
			if(roadCondition_flag==1)
			{
				if(feature.properties.natural==='water'|| feature.properties.building)
					{
						return false;
					}
				else
					return true;
			}	
			else
				{
					return false;	
				}
		};
		/*--------------------*/
		
		//过滤掉建筑和点数据,进行基本的数据分层
		//zc,新的geosever访问地址
		//var GeoJSONURL = 'http://166.111.68.197:11193/geoserver/v/{z}/{x}/{y}';
		//var url1 = 'http://os.cs.tsinghua.edu.cn/GeoServer/vectormap/geoserver';
		//1.15，新的地址访问方式
		var URL = window.location.href;
    var url1 = URL.substr(0, URL.lastIndexOf('/', URL.lastIndexOf('/')-1)+1);
    var GeoJSONURL = URLRef + 'geoserver/v/{z}/{x}/{y}';
    //var url1 = 'http://os.cs.tsinghua.edu.cn/GeoServer/vectormap/geoserver/';
		//var GeoJSONURL = url1 + 'v/{z}/{x}/{y}';
		
		var GeoJSONLowLayer = new L.TileLayer.GeoJSON(GeoJSONURL,{maxZoom:19,minZoom:13},
		{
			style:mystyle,
			onEachFeature:myoneach,
			filter:myLowfilter,
		})
		map.addLayer(GeoJSONLowLayer);
		var GeoJSONHighLayer = new L.TileLayer.GeoJSON(GeoJSONURL,{maxZoom:19,minZoom:13},
		{
			style:mystyle,
			onEachFeature:myoneach,
			filter:myHighfilter
		})
		map.addLayer(GeoJSONHighLayer);
		
		//zc----------------------------
		//var GeoJSONRCURL = 'http://os.cs.tsinghua.edu.cn/GeoServer/vectormap/geoserver/t/15/26969/12418/2010/03/12/160';
		//最后一位是时段，范围从1到288
		//var GeoJSONRCURL = url1+'t/{z}/{x}/{y}' + '/2010/03/12/' + roadConditionTime;
		var GeoJSONRCURL = URLRef + 'geoserver/t/{z}/{x}/{y}' + '/2010/03/12/' + roadConditionTime;
		var GeoJSONRoadConditionLayer = new L.TileLayer.GeoJSON(GeoJSONRCURL,{maxZoom:19,minZoom:13},
  		{
  			style:myroadconditionstyle,
  			onEachFeature:myoneach,
  			filter:myRoadConditionfilter
  		}) 
  		map.addLayer(GeoJSONRoadConditionLayer);
		//------------------------------
		console.log(GeoJSONHighLayer._container);
		console.log(GeoJSONLowLayer._container);
		//创建矢量数据层并将其装入地图容器
		GeoJSONHighLayer.setZIndex(4);
		GeoJSONLowLayer.setZIndex(3);
		//zc------------------------------------
		GeoJSONRoadConditionLayer.setZIndex(2);
		
		
		//设定所在div层的显示层级
		
		GeoJSONLowLayer.on('load',function() {
			console.log("all low visible tiles have been loaded");
			if(map.getZoom()>18){console.log("indoor time");}
			//obdata.update();
		});
		GeoJSONHighLayer.on('load',function() {
			console.log("all high visible tiles have been loaded");
			if(map.getZoom()>18){console.log("indoor time");}
			//zc,注释
			//obdata.update();
		});
		
		/*zc,路况显示层级--------------*/
		
		GeoJSONRoadConditionLayer.on('load',function() {
			obdata.update();
		});
		
		/*----------------------------*/
		//定义瓦片层加载完成后再加载建筑
		//leaflet-src.js在2460,2489,2566行处有修改
		//obdata定义于OSMBuildings-Leaflet.debug.js  2386行		
		var osmb = new OSMBuildings(map).load(GeoJSONURL,'');
		//加载建筑数据层,OSMBuildings-Leaflet.debug.js 在532,585,1025,2139行处有修改
	</script>
</body>
</html>
